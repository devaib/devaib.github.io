<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="CoreData" /><meta property="og:locale" content="en_US" /><meta name="description" content="Take an in-depth tour of how SwiftUI and Core Data work" /><meta property="og:description" content="Take an in-depth tour of how SwiftUI and Core Data work" /><link rel="canonical" href="http://localhost:4000/swiftui/CoreData" /><meta property="og:url" content="http://localhost:4000/swiftui/CoreData" /><meta property="og:site_name" content="devai.b" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-04T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CoreData" /><meta name="twitter:site" content="@Devaib" /><meta name="twitter:creator" content="@Devaib" /> <script type="application/ld+json"> {"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/swiftui/CoreData"},"headline":"CoreData","url":"http://localhost:4000/swiftui/CoreData","description":"Take an in-depth tour of how SwiftUI and Core Data work","dateModified":"2020-11-04T00:00:00-05:00","datePublished":"2020-11-04T00:00:00-05:00","@context":"https://schema.org"}</script><title> CoreData - devai.b</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="devai.b" href="/atom.xml"><link rel="alternate" type="application/json" title="devai.b" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">devai.b</h1>--><nav role="navigation"><ul><li><a href="/" >Writing</a></li><li><a href="/about" >About</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>CoreData</h2><h3 id="keywords">Keywords</h3><ul><li>URLSession.shared.dataTask</li><li>JSONEncoder/JSONDecoder</li><li>GeometryReader</li><li>Codable</li><li>@ViewBuilder</li><li>@escaping</li></ul><h3 id="keynotes">Keynotes</h3><ol><li>Managed objects are saved on calling <code class="highlighter-rouge">save()</code> on their managed object context</li><li>If all the properties of a type conform to the Hashable protocol, the type itself can also conform just by adding <code class="highlighter-rouge">Hashable</code> to its list of conformances</li><li>We can control the way Xcode generates code for a Core Data entity by adjusting the <code class="highlighter-rouge">Codegen</code> property in the data model inspector</li><li>We can filter a fetch request using <code class="highlighter-rouge">NSPredicate</code>. If you want more complex predicates you can combine multiple instances of <code class="highlighter-rouge">NSPredicate</code> using <code class="highlighter-rouge">NSCompoundPredicate</code></li><li><code class="highlighter-rouge">NSSet</code> is the Objective-C version of Swift’s <code class="highlighter-rouge">Set</code> type</li><li><code class="highlighter-rouge">%@</code> in an <code class="highlighter-rouge">NSPredicate</code> is dynamically replaced with some sort of value in quote marks</li><li>We can dynamically replace an <code class="highlighter-rouge">NSPredicate</code> string with an attribute name using <code class="highlighter-rouge">%K</code></li><li>All managed objects have a unique object ID. This works more or less like a UUID</li><li>We should check whether a managed object context has changes before we try to save it. This is as simple as reading its <code class="highlighter-rouge">hasChanges</code> property</li><li>Fetch requests take an array of sort descriptors, and they are applied in order</li><li><code class="highlighter-rouge">@NSManaged</code> pre-dates property wrappers in Swift</li><li>Fetch requests can not only be created using the <code class="highlighter-rouge">@FetchRequest</code> property wrapper. We can also create fetch requests without the property wrapper using the <code class="highlighter-rouge">FetchRequest</code> struct.</li></ol><h3 id="topics">Topics</h3><h4 id="creating-nsmanagedobject-subclasses">Creating NSManagedObject subclasses</h4><ol><li>Create entity <strong>Movie</strong> and add attributes</li><li><strong><em>Inspector</em></strong> &gt; <strong><em>Show Data Model Inspector</em></strong> and change <strong>Codegen</strong> to <strong>Manual/None</strong></li><li><strong>Editor</strong> &gt; <strong>Create NSManagedObject</strong></li><li>Add computed properties to avoid “nil coalescing”</li></ol><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@NSManaged</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
<span class="kd">@NSManaged</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">director</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
<span class="kd">@NSManaged</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">year</span><span class="p">:</span> <span class="kt">Int16</span>

<span class="kd">public</span> <span class="k">var</span> <span class="nv">wrappedTitle</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">title</span> <span class="p">??</span> <span class="s">"Unknown Title"</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="conditional-saving-of-nsmanagedobjectcontext">Conditional saving of NSManagedObjectContext</h4><ol><li>It’s common to bulk your saves together so that you save everything at once, which has a lower performance impact</li><li>Every managed object is given a <code class="highlighter-rouge">hasChanges</code> property</li><li>The entire context also contains a <code class="highlighter-rouge">hasChanges</code> property that checks whether any object owned by the context has changes</li><li>We should always wrap <code class="highlighter-rouge">save()</code> in the check, like this:</li></ol><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="n">hasChanges</span> <span class="p">{</span>
    <span class="k">try</span><span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="ensuring-core-data-objects-are-unique-using-constraints">Ensuring Core Data objects are unique using constraints</h4><ol><li>Core Data gives us constraints: we can make one attribute constrained so that it must always be unique</li><li>If there was some data already written that clashes with our constraint, we can choose how it should handle merging the data</li><li>Look in the data model inspector for <strong>Constraints</strong>, and press the + button directly below and rename it to “title”</li><li><p>Add following codes in <strong>ContentView.swift</strong></p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
     <span class="kd">@Environment</span><span class="p">(\</span><span class="o">.</span><span class="n">managedObjectContext</span><span class="p">)</span> <span class="k">var</span> <span class="nv">moc</span>
     <span class="kd">@FetchRequest</span><span class="p">(</span><span class="nv">entity</span><span class="p">:</span> <span class="kt">Movie</span><span class="o">.</span><span class="nf">entity</span><span class="p">(),</span> <span class="nv">sortDescriptors</span><span class="p">:</span> <span class="p">[])</span>
     <span class="k">var</span> <span class="nv">movies</span><span class="p">:</span> <span class="kt">FetchedResults</span><span class="o">&lt;</span><span class="kt">Movie</span><span class="o">&gt;</span>

     <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
         <span class="kt">VStack</span> <span class="p">{</span>
             <span class="kt">List</span><span class="p">(</span><span class="n">movies</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">movie</span> <span class="k">in</span>
                 <span class="kt">Text</span><span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">title</span> <span class="p">??</span> <span class="s">"Unknown"</span><span class="p">)</span>
             <span class="p">}</span>

             <span class="kt">Button</span><span class="p">(</span><span class="s">"Add"</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">let</span> <span class="nv">movie</span> <span class="o">=</span> <span class="kt">Movie</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">moc</span><span class="p">)</span>
                 <span class="n">movie</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">"Mulan"</span>
             <span class="p">}</span>
                
             <span class="kt">Button</span><span class="p">(</span><span class="s">"Save"</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">do</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="n">hasChanges</span><span class="p">{</span>
                         <span class="k">try</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
                     <span class="p">}</span>
                 <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                     <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
                 <span class="p">}</span>
             <span class="p">}</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div></div></li><li>Add merge policy in <strong>Persistence.swift</strong></li></ol><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">PersistenceController</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="k">let</span> <span class="nv">container</span><span class="p">:</span> <span class="kt">NSPersistentContainer</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">inMemory</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">container</span> <span class="o">=</span> <span class="kt">NSPersistentContainer</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"CoreDataProject"</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="n">viewContext</span><span class="o">.</span><span class="n">mergePolicy</span> <span class="o">=</span> <span class="kt">NSMergeByPropertyObjectTrumpMergePolicy</span>
        <span class="o">...</span>
</code></pre></div></div><h4 id="filtering-fetchrequest-using-nspredicate">Filtering @FetchRequest using NSPredicate</h4><p>When we use SwiftUI’s <code class="highlighter-rouge">@FetchRequest</code> property wrapper, we can provide an array of sort descriptors to control the ordering of results, but we can also provide an <code class="highlighter-rouge">NSPredicate</code> to control which results should be shown.</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">CoreData</span>
<span class="kd">import</span> <span class="kt">SwiftUI</span>

<span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@Environment</span><span class="p">(\</span><span class="o">.</span><span class="n">managedObjectContext</span><span class="p">)</span> <span class="k">var</span> <span class="nv">moc</span>
    <span class="kd">@FetchRequest</span><span class="p">(</span><span class="nv">entity</span><span class="p">:</span> <span class="kt">Ship</span><span class="o">.</span><span class="nf">entity</span><span class="p">(),</span> <span class="nv">sortDescriptors</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">predicate</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">var</span> <span class="nv">ships</span><span class="p">:</span> <span class="kt">FetchedResults</span><span class="o">&lt;</span><span class="kt">Ship</span><span class="o">&gt;</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">VStack</span> <span class="p">{</span>
            <span class="kt">List</span><span class="p">(</span><span class="n">ships</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">ship</span> <span class="k">in</span>
                <span class="kt">Text</span><span class="p">(</span><span class="n">ship</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">"Unknown name"</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="kt">Button</span><span class="p">(</span><span class="s">"Add Examples"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">ship1</span> <span class="o">=</span> <span class="kt">Ship</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">ship1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Enterprise"</span>
                <span class="n">ship1</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="s">"Star Trek"</span>

                <span class="k">let</span> <span class="nv">ship2</span> <span class="o">=</span> <span class="kt">Ship</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">ship2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Defiant"</span>
                <span class="n">ship2</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="s">"Star Trek"</span>

                <span class="k">let</span> <span class="nv">ship3</span> <span class="o">=</span> <span class="kt">Ship</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">ship3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Millennium Falcon"</span>
                <span class="n">ship3</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="s">"Star Wars"</span>

                <span class="k">let</span> <span class="nv">ship4</span> <span class="o">=</span> <span class="kt">Ship</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">ship4</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Executor"</span>
                <span class="n">ship4</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="s">"Star Wars"</span>

                <span class="k">try</span><span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Ask for ships that are from Star Wars, like this:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@FetchRequest</span><span class="p">(</span><span class="nv">entity</span><span class="p">:</span> <span class="kt">Ship</span><span class="o">.</span><span class="nf">entity</span><span class="p">(),</span> <span class="nv">sortDescriptors</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">predicate</span><span class="p">:</span> <span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"universe == 'Star Wars'"</span><span class="p">))</span> <span class="k">var</span> <span class="nv">ships</span><span class="p">:</span> <span class="kt">FetchedResults</span><span class="o">&lt;</span><span class="kt">Ship</span><span class="o">&gt;</span>
</code></pre></div></div><p>or use special syntax <code class="highlighter-rouge">%@</code> instead:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"universe == %@"</span><span class="p">,</span> <span class="s">"Star Wars"</span><span class="p">))</span>
</code></pre></div></div><p>We can also use comparison such as <code class="highlighter-rouge">&lt;</code>, <code class="highlighter-rouge">&gt;</code>. For example this will return Defiant, Enterprise, and Executor:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"name &lt; %@"</span><span class="p">,</span> <span class="s">"F"</span><span class="p">))</span> <span class="k">var</span> <span class="nv">ships</span><span class="p">:</span> <span class="kt">FetchedResults</span><span class="o">&lt;</span><span class="kt">Ship</span><span class="o">&gt;</span>
</code></pre></div></div><p>Use an IN predicate to check whether the universe is one of three options from an array, like this:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"universe IN %@"</span><span class="p">,</span> <span class="p">[</span><span class="s">"Aliens"</span><span class="p">,</span> <span class="s">"Firefly"</span><span class="p">,</span> <span class="s">"Star Trek"</span><span class="p">])</span>
</code></pre></div></div><p>Examine part of a string, using operators such as BEGINSWITH and CONTAINS. For example, this will return all ships that start with a capital E (case-sensitive):</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"name BEGINSWITH %@"</span><span class="p">,</span> <span class="s">"E"</span><span class="p">))</span>
</code></pre></div></div><p>To ignore case-sensitivity</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"name BEGINSWITH[c] %@"</span><span class="p">,</span> <span class="s">"e"</span><span class="p">))</span>
</code></pre></div></div><p>Flip predicates around using <code class="highlighter-rouge">NOT</code>:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"NOT name BEGINSWITH[c] %@"</span><span class="p">,</span> <span class="s">"e"</span><span class="p">))</span>
</code></pre></div></div><h4 id="dynamically-filtering-fetchrequest-with-swiftui">Dynamically filtering @FetchRequest with SwiftUI</h4><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="c1">//  FilteredList.swift</span>
<span class="c1">//  CoreDataProject</span>
<span class="c1">//</span>

<span class="kd">import</span> <span class="kt">SwiftUI</span>
<span class="kd">import</span> <span class="kt">CoreData</span>

<span class="kd">struct</span> <span class="kt">FilteredList</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">NSManagedObject</span><span class="p">,</span> <span class="kt">Content</span><span class="p">:</span> <span class="kt">View</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">fetchRequest</span><span class="p">:</span> <span class="kt">FetchRequest</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span>
    <span class="k">let</span> <span class="nv">content</span><span class="p">:</span> <span class="p">(</span><span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">List</span><span class="p">(</span><span class="n">fetchRequest</span><span class="o">.</span><span class="n">wrappedValue</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">content</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">filterKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">filterValue</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="kd">@ViewBuilder</span> <span class="nv">content</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Content</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fetchRequest</span> <span class="o">=</span> <span class="kt">FetchRequest</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">entity</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="nf">entity</span><span class="p">(),</span> <span class="nv">sortDescriptors</span><span class="p">:</span> <span class="p">[],</span>
                                            <span class="nv">predicate</span><span class="p">:</span> <span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"%K BEGINSWITH %@"</span><span class="p">,</span> <span class="n">filterKey</span><span class="p">,</span> <span class="n">filterValue</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="c1">//  ContentView.swift</span>
<span class="c1">//  CoreDataProject</span>
<span class="c1">//</span>

<span class="kd">import</span> <span class="kt">SwiftUI</span>
<span class="kd">import</span> <span class="kt">CoreData</span>

<span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@Environment</span><span class="p">(\</span><span class="o">.</span><span class="n">managedObjectContext</span><span class="p">)</span> <span class="k">var</span> <span class="nv">moc</span>
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">lastNameFilter</span> <span class="o">=</span> <span class="s">"A"</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">VStack</span> <span class="p">{</span>
            <span class="kt">FilteredList</span><span class="p">(</span><span class="nv">filterKey</span><span class="p">:</span> <span class="s">"lastName"</span><span class="p">,</span> <span class="nv">filterValue</span><span class="p">:</span> <span class="n">lastNameFilter</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nv">singer</span><span class="p">:</span> <span class="kt">Singer</span><span class="p">)</span> <span class="k">in</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">singer</span><span class="o">.</span><span class="n">wrappedFirstName</span><span class="se">)</span><span class="s"> </span><span class="se">\(</span><span class="n">singer</span><span class="o">.</span><span class="n">wrappedLastName</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="kt">Button</span><span class="p">(</span><span class="s">"Add Examples"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">taylor</span> <span class="o">=</span> <span class="kt">Singer</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">taylor</span><span class="o">.</span><span class="n">firstName</span> <span class="o">=</span> <span class="s">"Taylor"</span>
                <span class="n">taylor</span><span class="o">.</span><span class="n">lastName</span> <span class="o">=</span> <span class="s">"Swift"</span>

                <span class="k">let</span> <span class="nv">ed</span> <span class="o">=</span> <span class="kt">Singer</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">ed</span><span class="o">.</span><span class="n">firstName</span> <span class="o">=</span> <span class="s">"Ed"</span>
                <span class="n">ed</span><span class="o">.</span><span class="n">lastName</span> <span class="o">=</span> <span class="s">"Sheeran"</span>

                <span class="k">let</span> <span class="nv">adele</span> <span class="o">=</span> <span class="kt">Singer</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
                <span class="n">adele</span><span class="o">.</span><span class="n">firstName</span> <span class="o">=</span> <span class="s">"Adele"</span>
                <span class="n">adele</span><span class="o">.</span><span class="n">lastName</span> <span class="o">=</span> <span class="s">"Adkins"</span>

                <span class="k">try</span><span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="kt">Button</span><span class="p">(</span><span class="s">"Show A"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">lastNameFilter</span> <span class="o">=</span> <span class="s">"A"</span>
            <span class="p">}</span>

            <span class="kt">Button</span><span class="p">(</span><span class="s">"Show S"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">lastNameFilter</span> <span class="o">=</span> <span class="s">"S"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="one-to-many-relationships-with-core-data-swiftui-and-fetchrequest">One-to-many relationships with Core Data, SwiftUI, and @FetchRequest</h4><p>Create two entities: <strong>Candy</strong>, with attribute “name”, and <strong>Country</strong>, with attributes “fullName” and “shortName”. Then add a constaint for “shortName”.</p><p>With Country selected, press + under the Relationships table. Call the relationship “candy”, change its destination to Candy, then over in the data model inspector change Type to To Many.</p><p>Now select Candy, and add another relationship there. Call the relationship “origin”, change its destination to “Country”, then set its inverse to “candy” so Core Data understands the link goes both ways.</p><p>In <strong>Country</strong> class, we need to deal with <code class="highlighter-rouge">NSSet</code> while cleaning up Core Data’s optionals:</p><ol><li>Convert from <code class="highlighter-rouge">NSSet</code> to <code class="highlighter-rouge">Set&lt;Candy&gt;</code></li><li>Convert <code class="highlighter-rouge">Set&lt;Candy&gt;</code> into an array, so that <code class="highlighter-rouge">ForEach</code> can read individual values from there</li><li>Sort that array</li></ol><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="k">var</span> <span class="nv">candyArray</span><span class="p">:</span> <span class="p">[</span><span class="kt">Candy</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">set</span> <span class="o">=</span> <span class="n">candy</span> <span class="k">as?</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">Candy</span><span class="o">&gt;</span> <span class="p">??</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="k">set</span><span class="o">.</span><span class="n">sorted</span> <span class="p">{</span>
        <span class="nv">$0</span><span class="o">.</span><span class="n">wrappedName</span> <span class="o">&lt;</span> <span class="nv">$1</span><span class="o">.</span><span class="n">wrappedName</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">VStack</span> <span class="p">{</span>
    <span class="kt">List</span> <span class="p">{</span>
        <span class="kt">ForEach</span><span class="p">(</span><span class="n">countries</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">country</span> <span class="k">in</span>
            <span class="kt">Section</span><span class="p">(</span><span class="nv">header</span><span class="p">:</span> <span class="kt">Text</span><span class="p">(</span><span class="n">country</span><span class="o">.</span><span class="n">wrappedFullName</span><span class="p">))</span> <span class="p">{</span>
                <span class="kt">ForEach</span><span class="p">(</span><span class="n">country</span><span class="o">.</span><span class="n">candyArray</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">candy</span> <span class="k">in</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">candy</span><span class="o">.</span><span class="n">wrappedName</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">Button</span><span class="p">(</span><span class="s">"Add"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">candy1</span> <span class="o">=</span> <span class="kt">Candy</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Mars"</span>
        <span class="n">candy1</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="kt">Country</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy1</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="s">"UK"</span>
        <span class="n">candy1</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">fullName</span> <span class="o">=</span> <span class="s">"United Kingdom"</span>

        <span class="k">let</span> <span class="nv">candy2</span> <span class="o">=</span> <span class="kt">Candy</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"KitKat"</span>
        <span class="n">candy2</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="kt">Country</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy2</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="s">"UK"</span>
        <span class="n">candy2</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">fullName</span> <span class="o">=</span> <span class="s">"United Kingdom"</span>

        <span class="k">let</span> <span class="nv">candy3</span> <span class="o">=</span> <span class="kt">Candy</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Twix"</span>
        <span class="n">candy3</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="kt">Country</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy3</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="s">"UK"</span>
        <span class="n">candy3</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">fullName</span> <span class="o">=</span> <span class="s">"United Kingdom"</span>

        <span class="k">let</span> <span class="nv">candy4</span> <span class="o">=</span> <span class="kt">Candy</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy4</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Toblerone"</span>
        <span class="n">candy4</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="kt">Country</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="p">)</span>
        <span class="n">candy4</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">shortName</span> <span class="o">=</span> <span class="s">"CH"</span>
        <span class="n">candy4</span><span class="o">.</span><span class="n">origin</span><span class="p">?</span><span class="o">.</span><span class="n">fullName</span> <span class="o">=</span> <span class="s">"Switzerland"</span>

        <span class="k">try</span><span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="n">moc</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><span class="meta"><time datetime="2020-11-04T00:00:00-05:00">November 4, 2020</time> &middot; <a href="/tag/swiftui">swiftui</a>, <a href="/tag/hackingwithswift">hackingwithswift</a></span></section></main></body></html>
