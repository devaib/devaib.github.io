<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Weak self" /><meta property="og:locale" content="en_US" /><meta name="description" content="Understand weak self." /><meta property="og:description" content="Understand weak self." /><link rel="canonical" href="http://localhost:4000/swift/WeakSelf" /><meta property="og:url" content="http://localhost:4000/swift/WeakSelf" /><meta property="og:site_name" content="devai.b" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-21T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Weak self" /><meta name="twitter:site" content="@Devaib" /><meta name="twitter:creator" content="@Devaib" /> <script type="application/ld+json"> {"@type":"BlogPosting","datePublished":"2020-12-21T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/swift/WeakSelf"},"url":"http://localhost:4000/swift/WeakSelf","description":"Understand weak self.","headline":"Weak self","dateModified":"2020-12-21T00:00:00-05:00","@context":"https://schema.org"}</script><title> Weak self - devai.b</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="devai.b" href="/atom.xml"><link rel="alternate" type="application/json" title="devai.b" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">devai.b</h1>--><nav role="navigation"><ul><li><a href="/" >Writing</a></li><li><a href="/about" >About</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>Weak self</h2><h3 id="keywords">Keywords</h3><ul><li>weak self</li><li>capture list</li><li>strong capture</li><li>weak capture</li><li>implicit capture</li><li>owned capture</li><li>retained cycle/reference</li><li>memory leak</li></ul><h3 id="understand-what-a-capture-list-is">Understand what a capture list is</h3><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">import</span> <span class="kt">UIKit</span>

<span class="kd">func</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">by</span> <span class="nv">multiplier</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">((</span><span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="k">in</span>
        <span class="k">return</span> <span class="n">input</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">multiplier</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">let</span> <span class="nv">multiplyTwo</span> <span class="o">=</span> <span class="nf">multiply</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">multiplier</span><span class="p">)</span>
<span class="nf">multiplyTwo</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">// 10</span>

<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nf">multiplyTwo</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">// 10</span>

<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">let</span> <span class="nv">multiplyFour</span> <span class="o">=</span> <span class="nf">multiply</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">multiplier</span><span class="p">)</span>
<span class="nf">multiplyFour</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">// 20</span>

<span class="c1">/// Implicit capture</span>
<span class="k">var</span> <span class="nv">name</span> <span class="o">=</span> <span class="s">"A"</span>
<span class="k">var</span> <span class="nv">appendToName</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">appendToName</span><span class="p">(</span><span class="s">"B"</span><span class="p">)</span> <span class="c1">// AB</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">"C"</span>
<span class="nf">appendToName</span><span class="p">(</span><span class="s">"B"</span><span class="p">)</span> <span class="c1">// CB</span>

<span class="c1">/// Strong/explicit capture with capture list</span>

<span class="n">name</span> <span class="o">=</span> <span class="s">"A"</span>
<span class="k">var</span> <span class="nv">appendToCaptureName</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">appendToCaptureName</span><span class="p">(</span><span class="s">"B"</span><span class="p">)</span> <span class="c1">// AB</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">"C"</span>
<span class="nf">appendToCaptureName</span><span class="p">(</span><span class="s">"B"</span><span class="p">)</span> <span class="c1">// AB</span>
</code></pre></div></div><p><code class="highlighter-rouge">multiplyTwo</code> and <code class="highlighter-rouge">multiplyFour</code> can be used as functions. And the result of <code class="highlighter-rouge">multiplyTwo(5)</code> is always <strong>10</strong> because multiplier is in an inner level. On the other hand, variable/property <code class="highlighter-rouge">name</code> and the closure of <code class="highlighter-rouge">appendToName</code> are on the same level (in the same context). However, if we explicitly capture <code class="highlighter-rouge">name</code> by putting it in a capture list <code class="highlighter-rouge">[name]</code>, the closure will capture the current value of <code class="highlighter-rouge">name</code>.</p><h3 id="understand-different-kinds-of-captures">Understand different kinds of captures</h3><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">MyClass</span> <span class="p">{}</span>
<span class="k">var</span> <span class="nv">instance</span><span class="p">:</span> <span class="kt">MyClass</span><span class="p">?</span> <span class="o">=</span> <span class="kt">MyClass</span><span class="p">()</span>

<span class="k">var</span> <span class="nv">aClosure</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">aClosure</span><span class="p">()</span> <span class="c1">// Optional(__lldb_expr_24.MyClass)</span>
<span class="n">instance</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="nf">aClosure</span><span class="p">()</span> <span class="c1">// Optional(__lldb_expr_24.MyClass)</span>
</code></pre></div></div><p>The second time we call <code class="highlighter-rouge">aClosure</code> it still prints the same instance of <code class="highlighter-rouge">MyClass</code> because <code class="highlighter-rouge">aClosure</code> holds a strong reference to the instance. Because we strongly captured the property <code class="highlighter-rouge">instance</code>, the closure owns this property. For value types like structs and enums, this means that the closure copies the current value of an object over to its own area in memory where it owns the object. For a class, the closure will maintain a strong pointer reference to the object.</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">MyClass</span> <span class="p">{}</span>
<span class="k">var</span> <span class="nv">instance</span><span class="p">:</span> <span class="kt">MyClass</span><span class="p">?</span> <span class="o">=</span> <span class="kt">MyClass</span><span class="p">()</span>

<span class="k">var</span> <span class="nv">aClosure</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="n">instance</span><span class="p">]</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">aClosure</span><span class="p">()</span> <span class="c1">// Optional(__lldb_expr_26.MyClass)</span>
<span class="n">instance</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="nf">aClosure</span><span class="p">()</span> <span class="c1">// nil</span>
</code></pre></div></div><p>If we explicitly declare the property as a weak capture in the capture list, the system doesn’t count our closure’s reference to <code class="highlighter-rouge">instance</code> which means that as soon as the playground releases its reference to our instance of <code class="highlighter-rouge">MyClass</code> it can be deallocated.</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">MyClass</span> <span class="p">{}</span>
<span class="k">var</span> <span class="nv">instance</span><span class="p">:</span> <span class="kt">MyClass</span><span class="p">?</span> <span class="o">=</span> <span class="kt">MyClass</span><span class="p">()</span>

<span class="k">var</span> <span class="nv">aClosure</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="k">unowned</span> <span class="n">instance</span><span class="p">]</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">aClosure</span><span class="p">()</span> <span class="c1">// Optional(__lldb_expr_28.MyClass)</span>
<span class="n">instance</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="nf">aClosure</span><span class="p">()</span> <span class="c1">// Fatal error: Attempted to read an unowned reference but object 0x6000002b01d0 was already deallocated</span>
</code></pre></div></div><p>The impact on memory for an <code class="highlighter-rouge">unowned</code> capture is pretty much the same as <code class="highlighter-rouge">weak</code>. But if you want to assert that <code class="highlighter-rouge">instance</code> is still around when the closure is called, and want to crash your app if it’s not you can use an <code class="highlighter-rouge">unowned</code> reference.</p><h3 id="summary">Summary</h3><p>Weak capture is by far the most common capture and it’s usually a good default one to prevent retained cycle and memory leaks. So if you have <code class="highlighter-rouge">[weak self]</code> in your capture list, make sure to unwrap <code class="highlighter-rouge">self</code> in your closure body using <code class="highlighter-rouge">guard strongSelf = self else { return }</code> to make sure that <code class="highlighter-rouge">self</code> exists by the time the closure is executed.</p><span class="meta"><time datetime="2020-12-21T00:00:00-05:00">December 21, 2020</time> &middot; <a href="/tag/swift">swift</a>, <a href="/tag/future">future</a>, <a href="/tag/promise">promise</a></span></section></main></body></html>
